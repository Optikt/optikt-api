name: üß™ Run Pytest

on:
  workflow_run:
    workflows: ["Build and Lint"]
    types:
      - completed
    branches: [main]

jobs:
  test:
    name: Execute Tests
    runs-on: ubuntu-latest

    # Check if the preceding workflow (Build and Lint) succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4
        # Crucial step: checkout the specific commit from the previous workflow
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: üêç Set up Python 3.10.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.10.12"

      - name: ‚ôªÔ∏è Restore Python dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: ${{ env.pythonLocation }}
          key: ${{ runner.os }}-python-${{ hashFiles('requirements.txt') }}

      - name: ‚öôÔ∏è Install if cache miss (should be rare)
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          python -m pip install --upgrade 

          pip install -r requirements.txt

      - name: üß™ Run Pytest
        env:
          # If your app relies on environment variables (like DATABASE_URL),
          # you should pass them here as GitHub Secrets (e.g., DB_SECRET)
          # DATABASE_URL: ${{ secrets.DB_SECRET }}
          SECRET_KEY: "testing-secret-key-safe-to-share"
        run: |
          # Use your pytest.ini configuration
          pytest -v
